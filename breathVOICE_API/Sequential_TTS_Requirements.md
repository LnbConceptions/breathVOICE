# BreathVOICE 逐条TTS生成需求规范

## 📋 需求概述

为了支持WebUI的逐条语音生成工作流，需要在现有的批量TTS API基础上，新增单条TTS生成接口，以实现：

1. **逐条生成**：WebUI可以逐条向TTS API发送请求
2. **实时反馈**：每生成一条音频后，立即在WebUI上显示播放控件
3. **停止控制**：用户可以随时停止生成，完成当前任务后不再发送后续请求

## 🎯 核心功能需求

### 1. 单条TTS生成接口

**端点**: `POST /breathvoice/single-tts`

**功能描述**:
- 接收单个TTS请求，生成一个音频文件
- 支持与批量TTS相同的参考音频智能选择逻辑
- 返回生成结果和音频文件路径

**请求格式**:
```json
{
  "text": "要转换的文本内容",
  "filename": "输出文件名.wav",
  "voice_group_id": "角色组ID"
}
```

**响应格式**:
```json
{
  "success": true,
  "message": "Single TTS completed successfully",
  "result": {
    "filename": "greeting_001.wav",
    "text": "你好，欢迎来到我们的世界！",
    "reference_audio": "ChineseWoman_greeting.wav",
    "output_path": "examples/greeting_001.wav",
    "status": "success",
    "processing_time": 2.34
  }
}
```

### 2. 参考音频智能选择

**需求**:
- 单条TTS接口应使用与批量TTS相同的智能参考音频选择逻辑
- 根据文件名前缀自动选择最合适的参考音频
- 支持以下映射规则：
  - `greeting_*` → `ChineseWoman_greeting.wav`
  - `B1_*`, `B2_*` → `ChineseWoman_B1_B2.wav`
  - `B3_*`, `B4_*` → `ChineseWoman_B3_B4.wav`
  - `B5_*`, `orgasm_*`, `climax_*` → `ChineseWoman_B5_orgasm.wav`

### 3. 错误处理

**需求**:
- 提供详细的错误信息
- 即使请求失败，也要返回结构化的结果对象
- 支持以下错误类型：
  - 角色组不存在
  - 文本内容为空
  - 文件名格式错误
  - 服务器内部错误

## 🔧 技术实现要求

### 1. API 兼容性

- 新的单条TTS接口应与现有批量TTS接口保持一致的行为
- 使用相同的参考音频选择逻辑
- 保持相同的输出文件路径结构
- 返回格式应与批量TTS中的单个结果项保持一致

### 2. 性能要求

- 单条请求的处理时间应与批量请求中的单个项目相当
- 支持并发处理多个单条请求
- 不应因为拆分请求而显著增加总体处理时间

### 3. 文件管理

- 生成的音频文件应保存在与批量TTS相同的目录结构中
- 文件命名规则保持一致
- 支持文件覆盖和去重逻辑

## 🚀 WebUI 集成工作流

### 1. 逐条生成流程

```
用户选择台词集 → 
WebUI逐条发送请求 → 
TTS API生成单个音频 → 
WebUI显示播放控件 → 
用户可播放当前音频 → 
继续下一条请求 → 
...直到全部完成
```

### 2. 停止机制

```
用户点击"停止生成" → 
WebUI设置停止标志 → 
完成当前TTS任务 → 
不再发送后续请求 → 
显示已完成的音频列表
```

### 3. 状态管理

- **等待生成**: 台词在队列中等待
- **正在生成**: 当前正在处理的台词
- **已生成**: 生成成功，可播放
- **生成失败**: 生成失败，显示错误信息
- **已停止**: 用户主动停止，未处理的台词

## 📝 实现优先级

### 高优先级 (必须实现)
1. ✅ 单条TTS生成接口 (`/breathvoice/single-tts`)
2. ✅ 参考音频智能选择逻辑
3. ✅ 错误处理和响应格式
4. ✅ API文档更新

### 中优先级 (建议实现)
1. 并发处理优化
2. 请求队列管理
3. 生成进度跟踪

### 低优先级 (可选实现)
1. 请求缓存机制
2. 音频质量参数调节
3. 批量转单条的兼容模式

## 🧪 测试要求

### 1. 功能测试
- 单条TTS生成的基本功能
- 参考音频选择的准确性
- 错误处理的完整性

### 2. 性能测试
- 单条请求的响应时间
- 并发请求的处理能力
- 与批量请求的性能对比

### 3. 集成测试
- WebUI与新API的集成
- 逐条生成工作流的完整性
- 停止机制的可靠性

## 📚 相关文档

- `BreathVOICE_API_Documentation.md` - 完整API文档
- `API_Integration_Guide.md` - 集成指南
- `Developer_Resource_Package.md` - 开发者资源包

## 🎉 预期效果

实现后，用户将能够：

1. **实时查看进度**: 每生成一条音频，立即在界面上看到结果
2. **即时试听**: 不需要等待全部生成完成，可以立即播放已生成的音频
3. **灵活控制**: 可以随时停止生成过程，节省时间和资源
4. **更好体验**: 提供更流畅、更可控的语音生成体验

这种逐条生成的方式将大大提升用户体验，特别是在处理大量台词时，用户可以边生成边检查效果，及时发现问题并调整。