# Tease 提示词测试页（编辑版）备忘录

本文档总结该网页的业务逻辑、运行方式、以及此前导致无法测试的问题与解决方案，作为后续维护与使用的参考。

---

## 1. 页面目标与结构
- 页面用于“tease”事件的台词编辑与逐条生成测试。
- 仅保留“编辑版”交互：每行包含
  - 复选框（选择是否生成）
  - 动作参数（只读、来自模板）
  - 台词文本框（可编辑）
- 顶部提供按钮：
  - 全选 / 全不选
  - 构建综合提示词（预览）：生成并展示最终注入 LLM 的 JSON 提示词
  - 生成选中台词（逐条实时报更）：按所选行逐条请求 LLM 并更新台词
- 右侧“提示词预览”展示完整 JSON；“LLM 状态日志”展示每次调用的连接、重试、异常信息等。

## 2. 生成流程（可视化交互）
1. 选择角色与 LLM 配置。
2. （可选）在编辑表直接调整某些行的“台词”初始文本；复选框选择需要生成的行，不选则默认全部生成。
3. 点击“构建综合提示词（预览）”：
   - 后端调用 `DialogueGenerator.create_comprehensive_prompt_template(...)` 构建 JSON 模板。
   - 将模板 JSON 展示在“提示词预览”。
4. 点击“生成选中台词（逐条实时报更）”：
   - 逐条请求 LLM，每条完成后实时更新对应行的“台词”。
   - “LLM 状态日志”记录连接与异常信息，便于排查。

## 3. 英文提示词策略（重要变更）
- 目标：提示词与生成倾向统一使用英文，便于多数 LLM 的理解与输出。
- 实施：在以下函数中强制 `language="English"`
  - `on_build_prompt_v2`
  - `gen_selected_v2`
  - `gen_selected`（旧路径，UI 已隐藏但保留兼容）
- 影响：
  - 提示词模板中的 `All dialogue must be in English` 等要求生效。
  - 生成结果更稳定地倾向英文输出（若模型强行输出其他语言，可在后续模板中进一步强调）。

## 4. 关键修复与原因分析
此前无法正常测试的核心问题与对应修复如下：

- 问题 A：浏览器报错 `TypeError: Cannot read properties of null (reading 'headers')` 与队列请求 `net::ERR_ABORTED`
  - 原因：旧版 `Dataframe` 路径在预处理/渲染时出错，导致队列中断，前端渲染失败。
  - 修复：隐藏旧版 `Dataframe` 及相关按钮，仅保留“编辑版”。

- 问题 B：`AttributeError: 'NoneType' object has no attribute 'data'` 出现在 `gradio/components/dataframe.py`
  - 原因：同属旧版表格路径在数据处理阶段出现异常，触发后端错误并中断队列。
  - 修复：同上，彻底隐藏旧版路径。

- 问题 C：LLM 接口异常导致队列中断、浏览器出现 `ERR_ABORTED`
  - 原因：请求过程中抛异常，未被捕获，队列失败传递到前端。
  - 修复：`gen_selected_v2` 与旧版 `gen_selected` 统一在调用处包裹 `try/except`，并将异常信息写入“LLM 状态日志”，避免队列被异常中断。

- 问题 D：旧路径在早退分支返回不当，造成渲染错误
  - 原因：早退时返回空值导致前端更新失败。
  - 修复：早退分支统一使用 `gr.update(value="")` 进行安全更新，避免渲染异常。

## 5. 布局与交互优化（编辑版）
- 复选框列最小化（仅容纳 checkbox）：`min_width=32`、`scale=0`、`show_label=False`。
- “动作参数”列固定宽度：`scale=3`，`show_label=False`。
- “台词”列加宽：`scale=9`，`show_label=False`。
- 移除“动作参数”和“台词”列头显示，界面更简洁。

## 6. 使用与测试建议
- 首次进入或更新代码后，请浏览器硬刷新（清缓存、重载）。
- 若看到 `net::ERR_ABORTED` 的心跳终止日志：
  - 多为短时网络/队列心跳中断，若页面功能正常可忽略。
  - 若伴随前端渲染错误，请查看“LLM 状态日志”与后端终端日志定位具体异常。
- “提示词预览”应展示英文 JSON 提示词；如模型输出非英文，可在模板 `requirements` 增加更明确的约束（如“Strictly return English only”）。
- 生成台词为逐条更新；选择为空时会默认生成全部条目。

## 7. 代码参考点
- UI 构建：`test_tease_prompt_ui.py`
- 提示词模板与 LLM 调用：`dialogue_generator.py`
- 旧版实现（仅参考）：`dialogue_generator_old.py`

## 8. 后续改进方向（可选）
- 在 UI 中标注“提示词语言固定为英文”。
- 为生成结果添加语言检测与自动纠偏（非英文时追加一次重试并强调规则）。
- 将“LLM 状态日志”支持下载，便于问题现场保存与排查。

---

以上为当前稳定运行版本的要点与注意事项。若后续出现新的错误栈，请按“LLM 状态日志 + 终端日志”组合进行定位，并在 UI 或模板中逐步收敛异常路径。